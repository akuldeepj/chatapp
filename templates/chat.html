<!DOCTYPE html>
<html>
<head>
    <title>Chat</title>
    <style>
        #chat-messages {
            max-height: 300px;
            overflow-y: scroll;
            border: 1px solid #ccc;
            padding: 10px;
        }
        
        .message {
            margin-bottom: 10px;
            padding: 10px;
            border-radius: 5px;
        }
        
        .other-user {
            background-color: #e9e9e9;
            text-align: left;
        }
        
        .logged-in-user {
            background-color: #b2dbf1;
            text-align: right;
        }
        
        
        #chat-form {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
        }

        #message-input {
            flex-grow: 1;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 3px;
            font-size: 16px;
        }

        #chat-form input[type="submit"] {
            padding: 10px 20px;
            background-color: #333;
            color: #fff;
            border: none;
            border-radius: 3px;
            font-size: 16px;
            cursor: pointer;
        }
       
        h1 {
            color: #333;
        }

        .chatId {
            color: #666;
        }
        
        .col{
            background-color: #2D3E4E !important;
        }


        #chat-form {
            margin-top: 20px;
        }

        #message-input {
            width: 200px;
            padding: 5px;
        }

        #chat-form input[type="submit"] {
            padding: 5px 10px;
            background-color: grey;
            color: #fff;
            border: none;
            cursor: pointer;
        }
    </style>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" crossorigin="anonymous">
</head>
<body>
    <div class="form-body">
        <nav class="navbar navbar-expand-lg bg-body-tertiary col" style="background-color: #2D3E4E !important;">
            <div class="container-fluid">
                <h3 style="margin-right:10px;color:white" > Chat </h3>
              <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
              </button>
              <div class="collapse navbar-collapse" id="navbarSupportedContent">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                  <li class="nav-item">
                    <a class="nav-link active" style="color:white" aria-current="page" href="/dashboard">Home</a>
                  </li>
                </ul>
                  <button class="btn btn-outline-success" style="color:white"  onclick="redirectToPage()">LogOut</button>
              </div>
            </div>
          </nav>
         <h2 class="chatId">Chat ID: {{ chat_id }}</h2> 
        <h3>Welcome, {{ user.Username }}!</h3>
      
        <div id="chat-messages" class="bg-body-tertiary">
            {% for message in messages %}
                {% if message.id == user.id %}
                    <div class="message logged-in-user">
                        <p>{{ message.id }}: {{ message.msg }}</p>
                    </div>
                {% else %}
                    <div class="message other-user">
                        <p>{{ message.id }}: {{ message.msg }}</p>
                    </div>
                {% endif %}
            {% endfor %}
        </div>    
    
    <div>
    <form id="chat-form" action="{{ url_for('chat', chat_id=chat_id) }}" method="post">
        <input type="text" name="message" id="message-input" placeholder="Type your message" required>
        <input type="submit" value="Send" style="background-color:blue">
    </form>
</div>
</div>
    <script>
        // Automatically scroll to the bottom of the chat messages
        var chatMessages = document.getElementById('chat-messages');
        chatMessages.scrollTop = chatMessages.scrollHeight;

        // Function to update the chat messages with new messages
        function updateChatMessages(messages) {
            var chatDiv = document.getElementById('chat-messages');

            messages.forEach(function(message) {
                var messageDiv = document.createElement('p');
                messageDiv.textContent = message.id + ': ' + message.msg;
                chatDiv.appendChild(messageDiv);
            });

            // Scroll to the bottom of the chat messages
            chatDiv.scrollTop = chatDiv.scrollHeight;
        }

        // Function to send a new message
        function sendMessage(event) {
            event.preventDefault();
            var messageInput = document.getElementById('message-input');
            var message = messageInput.value;

            // Make an AJAX request to send the message to the server
            var xhr = new XMLHttpRequest();
            xhr.open('POST', "{{ url_for('chat', chat_id=chat_id) }}");
            xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
            xhr.onload = function() {
                if (xhr.status === 200) {
                    // Clear the input field after successful message sending
                    messageInput.value = '';
                }
            };
            xhr.send('message=' + encodeURIComponent(message));
        }

        // Attach the submit event listener to the chat form
        var chatForm = document.getElementById('chat-form');
        chatForm.addEventListener('submit', sendMessage);

        // Function to continuously check for new messages
        var lastMessageTimestamp = '';  // Initialize variable to store the timestamp of the last received message

function checkNewMessages() {
    var xhr = new XMLHttpRequest();
    xhr.open('GET', "{{ url_for('get_messages', chat_id=chat_id) }}");
    xhr.setRequestHeader('Content-Type', 'application/json');
    xhr.onload = function() {
        if (xhr.status === 200) {
            var newMessages = JSON.parse(xhr.responseText);

            // Filter out the messages with a timestamp greater than the last received message's timestamp
            var filteredMessages = newMessages.filter(function(message) {
                return message.timestamp > lastMessageTimestamp;
            });

            if (filteredMessages.length > 0) {
                updateChatMessages(filteredMessages);

                // Update the last received message's timestamp
                lastMessageTimestamp = filteredMessages[filteredMessages.length - 1].timestamp;
            }
        }
    };
    xhr.send();
}


        // Check for new messages every 2 seconds (adjust as needed)
        setInterval(checkNewMessages, 1000);
        function redirectToPage() {
            // Redirect to the desired page
            window.location.href = "/login";
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz" crossorigin="anonymous"></script>
</body>
</html>
